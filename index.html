<!DOCTYPE html>
<html lang="he" >
<head>
<meta charset="UTF-8" />
<title>Redirecting...</title>
<style>
  body {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: #f4f1e6;
    margin: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }

  .book {
    width: 120px;
    height: 160px;
    perspective: 800px;
    position: relative;
  }

  .book__cover, .book__page {
    position: absolute;
    width: 120px;
    height: 160px;
    background: linear-gradient(135deg, #a85a1a, #61340a);
    border-radius: 8px;
    box-shadow: 2px 4px 12px rgba(0,0,0,0.3);
    transform-origin: left;
    top: 0;
    left: 0;
  }

  .book__page {
    background: #fff8dc;
    box-shadow: inset 2px 0 8px rgba(0,0,0,0.1);
    z-index: 2;
    transform-origin: left;
    animation: openPage 2s ease forwards;
  }

  .book__cover {
    z-index: 3;
  }

  @keyframes openPage {
    0% {
      transform: rotateY(0deg);
      box-shadow: inset 2px 0 8px rgba(0,0,0,0.1);
    }
    100% {
      transform: rotateY(-120deg);
      box-shadow: none;
    }
  }

  .loading-text {
    margin-top: 180px;
    font-weight: 600;
    font-size: 1.1rem;
    color: #5a4b3b;
    letter-spacing: 0.05em;
  }

  iframe#content-frame {
    width: 100vw;
    height: 100vh;
    border: none;
    display: none;
    flex-grow: 1;
  }
</style>
</head>
<body>
  <div class="book" id="book-animation">
    <div class="book__cover"></div>
    <div class="book__page"></div>
  </div>
  <div class="loading-text" id="loading-text">טוען הפניה...</div>
  
  <iframe id="content-frame" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>

<script>
(() => {
  const API_URL = "https://api.jsonbin.io/v3/b/689b2b06ae596e708fc821af/latest";
  const CHECK_INTERVAL_MS = 3000;

  let currentUrl = null;
  const iframe = document.getElementById("content-frame");
  const bookAnim = document.getElementById("book-animation");
  const loadingText = document.getElementById("loading-text");

  async function fetchUrlFromApi() {
    try {
      const res = await fetch(API_URL);
      const json = await res.json();
      if (json.record && json.record.url) {
        return json.record.url;
      } else {
        console.error("❌ לא נמצאה כתובת להפניה ב-API");
        return null;
      }
    } catch (err) {
      console.error("⚠ שגיאה בטעינת ה-API", err);
      return null;
    }
  }

  // ניסיון לגשת ל-DOM של ה-iframe וליירט לחיצות על קישורים (רק אם אותו מקור)
  function tryAttachLinkInterceptor() {
    try {
      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
      if (!iframeDoc) return;

      // מאזין ללחיצות על קישורים
      iframeDoc.addEventListener('click', e => {
        let anchor = e.target;
        while (anchor && anchor.tagName !== 'A') {
          anchor = anchor.parentElement;
        }
        if (!anchor) return;

        // אם הקישור מנסה להפתח ב-target="_blank" או target אחר שפותח מחוץ לiframe
        if (anchor.target && anchor.target !== '_self' && anchor.target !== '') {
          e.preventDefault();
          const href = anchor.href;
          if (href) {
            // טוען את הקישור בתוך הiframe
            iframe.src = href;
            // אפשר לעדכן currentUrl כדי לא לטעון שוב מה-API
            currentUrl = href;
            console.log("Captured link with target, loading inside iframe:", href);
          }
        }
      }, true); // useCapture כדי לתפוס מוקדם
    } catch (e) {
      // כנראה Cross-Origin, לא ניתן לגשת ל-iframe DOM
      console.warn("Cannot access iframe DOM (likely cross-origin), link interceptor disabled.");
    }
  }

  // מאזין לטעינת iframe ומנסה לחבר את היירוט
  iframe.addEventListener('load', () => {
    tryAttachLinkInterceptor();
  });

  // מאזין להודעות postMessage מה-iframe (אם הדף שם שולח)
  window.addEventListener('message', e => {
    // ניתן לבדוק e.origin אם רוצים אבטחה
    const msg = e.data;
    if (msg && msg.type === 'navigate' && msg.url) {
      console.log("Received navigation request from iframe via postMessage:", msg.url);
      iframe.src = msg.url;
      currentUrl = msg.url;
    }
  });

  async function init() {
    const url = await fetchUrlFromApi();
    if (!url) {
      loadingText.textContent = "❌ לא נמצאה כתובת להפניה";
      return;
    }
    currentUrl = url;

    // המתנה לאנימציה (2.2 שניות)
    await new Promise(r => setTimeout(r, 2200));

    bookAnim.style.display = "none";
    loadingText.style.display = "none";

    iframe.style.display = "block";
    iframe.src = currentUrl;

    setInterval(async () => {
      const newUrl = await fetchUrlFromApi();
      if (newUrl && newUrl !== currentUrl) {
        console.log("URL השתנה! טוען מחדש:", newUrl);
        currentUrl = newUrl;
        iframe.src = currentUrl;
      }
    }, CHECK_INTERVAL_MS);
  }

  window.onload = init;
})();
</script>
</body>
</html>
