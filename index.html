<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8" />
<title>Redirecting...</title>
<!-- חשוב למסך מלא ב־Web Clip -->
<meta name="apple-mobile-web-app-capable" content="yes">

<!-- מבקש טקסט שחור על רקע לבן -->
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<!-- רמז לאייפד לבחור טקסט כהה על רקע לבן -->
<meta name="theme-color" content="#ffffff">

<style>
  body {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: #f4f1e6;
    margin: 0;
    padding: 20px;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }

  .book {
    width: 120px;
    height: 160px;
    perspective: 800px;
    position: relative;
  }

  .book__cover, .book__page {
    position: absolute;
    width: 120px;
    height: 160px;
    background: linear-gradient(135deg, #a85a1a, #61340a);
    border-radius: 8px;
    box-shadow: 2px 4px 12px rgba(0,0,0,0.3);
    transform-origin: left;
    top: 0;
    left: 0;
  }

  .book__page {
    background: #fff8dc;
    box-shadow: inset 2px 0 8px rgba(0,0,0,0.1);
    z-index: 2;
    transform-origin: left;
    animation: openPage 2s ease forwards;
  }

  .book__cover {
    z-index: 3;
  }

  @keyframes openPage {
    0% {
      transform: rotateY(0deg);
      box-shadow: inset 2px 0 8px rgba(0,0,0,0.1);
    }
    100% {
      transform: rotateY(-120deg);
      box-shadow: none;
    }
  }

  .loading-text {
    margin-top: 180px;
    font-weight: 600;
    font-size: 1.1rem;
    color: #5a4b3b;
    letter-spacing: 0.05em;
    text-align: center;
  }

  .history-container {
    display: none;
    max-width: 600px;
    margin-top: 20px;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    text-align: right;
    direction: rtl;
  }

  .history-title {
    font-size: 1.3rem;
    font-weight: bold;
    color: #5a4b3b;
    margin-bottom: 15px;
    border-bottom: 2px solid #a85a1a;
    padding-bottom: 8px;
  }

  .history-item {
    margin: 10px 0;
    padding: 12px;
    background: #f9f7f4;
    border-radius: 8px;
    border: 1px solid #e0ddd6;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .history-item:hover {
    background: #f0ede6;
    border-color: #a85a1a;
    transform: translateX(-2px);
  }

  .history-item-title {
    font-weight: 600;
    color: #5a4b3b;
    margin-bottom: 5px;
  }

  .history-item-location {
    font-size: 0.9rem;
    color: #7a6b5b;
    margin-bottom: 3px;
  }

  .history-item-time {
    font-size: 0.8rem;
    color: #9a8b7b;
  }

  .error-message {
    color: #d32f2f;
    margin-top: 20px;
    padding: 15px;
    background: #ffebee;
    border-radius: 8px;
    border: 1px solid #f8bbd9;
    text-align: center;
  }

  .spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #a85a1a;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 10px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
<body>
  <div class="book" id="book-animation">
    <div class="book__cover"></div>
    <div class="book__page"></div>
  </div>
  <div class="loading-text" id="loading-text">טוען הפניה...</div>
  
  <div class="history-container" id="history-container">
    <div class="history-title">מקורות אחרונים</div>
    <div id="history-list"></div>
  </div>
  
  <div class="error-message" id="error-message" style="display: none;"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAKJYP86LNjzW_3mXhnEG8BcW9R_Cebf8Y",
    authDomain: "alhatorah-f3641.firebaseapp.com",
    databaseURL: "https://alhatorah-f3641-default-rtdb.firebaseio.com/",
    projectId: "alhatorah-f3641",
    storageBucket: "alhatorah-f3641.firebasestorage.app",
    messagingSenderId: "490409539037",
    appId: "1:490409539037:web:ecbee0f45592c07ebab234"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const urlRef = ref(db, 'currentUrl');

  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxNHNZyJfSJBcvfuay5Jv5Hx9gMzD0foJU4XUofQ2O6K1wavqQubRFxzwqbTn4m-SEi/exec';
  const MAX_AGE_SECONDS = 20;

  let currentUrl = null;

  function showError(message) {
    const errorDiv = document.getElementById('error-message');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
  }

  function hideLoader() {
    document.getElementById("book-animation").style.display = "none";
    document.getElementById("loading-text").style.display = "none";
  }

  function showHistory(backupData) {
    hideLoader();
    const historyContainer = document.getElementById('history-container');
    const historyList = document.getElementById('history-list');
    
    if (!backupData) {
      showError('לא הצלחתי לטעון את הנתונים מהשרת');
      return;
    }

    historyList.innerHTML = '';
    
    // משלב את כל הנתונים לרשימה אחת ממוינת לפי תאריך
    const allItems = [];
    
    // הוספת הערות אישיות
    if (backupData.personalNotes && backupData.personalNotes.length > 0) {
      backupData.personalNotes.forEach(item => {
        allItems.push({
          title: 'הערה אישית',
          location: item.hesource || item.ensource || '',
          timestamp: item.date_created,
          url: item.link,
          type: 'note'
        });
      });
    }
    
    // הוספת סימניות
    if (backupData.bookmarks && backupData.bookmarks.length > 0) {
      backupData.bookmarks.forEach(item => {
        allItems.push({
          title: 'סימנייה',
          location: item.hesource || item.ensource || '',
          timestamp: item.date_created,
          url: item.link,
          type: 'bookmark'
        });
      });
    }
    
    // הוספת היסטוריה
    if (backupData.personalHistory && backupData.personalHistory.length > 0) {
      backupData.personalHistory.forEach(item => {
        allItems.push({
          title: 'צפייה אחרונה',
          location: item.hesource || item.ensource || '',
          timestamp: item.date_viewed,
          url: item.link,
          type: 'history'
        });
      });
    }
    
    if (allItems.length === 0) {
      showError('לא נמצאו מקורות אחרונים');
      return;
    }

    // מיון לפי תאריך (החדשים קודם)
    allItems.sort((a, b) => {
      const dateA = new Date(a.timestamp || 0).getTime();
      const dateB = new Date(b.timestamp || 0).getTime();
      return dateB - dateA;
    });
    
    // הצגת רק 10 הפריטים האחרונים
    const recentItems = allItems.slice(0, 10);
    
    recentItems.forEach((item, index) => {
      const historyItem = document.createElement('div');
      historyItem.className = 'history-item';
      
      const title = item.title || `מקור ${index + 1}`;
      const location = item.location || '';
      const timestamp = item.timestamp ? new Date(item.timestamp).toLocaleString('he-IL') : '';
      const url = item.url || '';
      
      // אייקון לפי סוג הפריט
      const icon = item.type === 'note' ? '📝' : 
                   item.type === 'bookmark' ? '🔖' : '👁️';
      
      historyItem.innerHTML = `
        <div class="history-item-title">${icon} ${title}</div>
        <div class="history-item-location">${location}</div>
        <div class="history-item-time">${timestamp}</div>
      `;
      
      historyItem.addEventListener('click', () => {
        if (url) {
          window.location.href = url;
        }
      });
      
      historyList.appendChild(historyItem);
    });
    
    historyContainer.style.display = 'block';
  }

  function isDataOld(timestamp) {
    if (!timestamp) return true;
    
    const now = new Date().getTime();
    const dataTime = new Date(timestamp).getTime();
    const ageInSeconds = (now - dataTime) / 1000;
    
    return ageInSeconds > MAX_AGE_SECONDS;
  }

  async function fetchFromGoogleScript() {
    try {
      document.getElementById("loading-text").innerHTML = 'טוען היסטוריה... <span class="spinner"></span>';
      
      const response = await fetch(GOOGLE_SCRIPT_URL);
      
      if (!response.ok) {
        throw new Error(`שגיאת שרת: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error);
      }
      
      return data;
    } catch (error) {
      console.error('שגיאה בטעינת נתונים מגוגל סקריפט:', error);
      showError(`שגיאה בטעינת נתונים: ${error.message}`);
      return null;
    }
  }

  onValue(urlRef, async (snapshot) => {
    if (!snapshot.exists()) {
      console.error("❌ אין ערך ב־currentUrl");
      await fetchFromGoogleScript().then(data => {
        if (data && (data.personalNotes || data.bookmarks || data.personalHistory)) {
          showHistory(data);
        }
      });
      return;
    }

    const urlData = snapshot.val();
    console.log("✅ התקבל נתון:", urlData);

    // בדיקה אם הנתון הוא רק URL או אובייקט עם timestamp
    let url, timestamp;
    
    if (typeof urlData === 'string') {
      url = urlData;
      timestamp = null; // נתון ישן ללא timestamp
    } else if (typeof urlData === 'object') {
      url = urlData.url;
      timestamp = urlData.timestamp;
    }

    // בדיקה אם הנתונים ישנים
    if (isDataOld(timestamp)) {
      console.log("⏰ הנתונים ישנים, טוען היסטוריה מגוגל סקריפט");
      
      const scriptData = await fetchFromGoogleScript();
      if (scriptData) {
        if (scriptData.personalNotes || scriptData.bookmarks || scriptData.personalHistory) {
          showHistory(scriptData);
        } else if (scriptData.url) {
          // אם יש URL חדש, מפנים אליו
          console.log("➡️ מפנה ל-URL חדש:", scriptData.url);
          hideLoader();
          window.location.href = scriptData.url;
        }
      }
      return;
    }

    // אם הנתונים חדשים ויש URL
    if (url && url !== currentUrl) {
      currentUrl = url;
      console.log("➡️ מפנה ל-URL עדכני:", url);
      hideLoader();
      window.location.href = url;
    }
  });
</script>
</body>
</html>
